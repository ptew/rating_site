
{% extends "base.html" %}
{% load dajaxice_templatetags %}
{% load ratings_filters %}

{% block title %}
Advice Ratings Home Page
{% endblock %}

{% block head %}
  {% dajaxice_js_import %}

  <script type="text/javascript">
      function my_callback(data){
      };

      $(window).load(function(){
        var world = $($("#world")[0]).data('world');
        console.log("World: " + world);
        $('#loadModal').modal('show');
    });

    function submit() {
      $(".rateit.vote").each( function() {
          var rater = $(this);
          var value = rater.rateit('value');

          var advice_id = $(rater).data('advice-id');
          var profile_id = $(rater).data('profile-id');
          var user_id = $($("#uid")[0]).data('uid');
          var isPerformance = rater.hasClass("performance");
          Dajaxice.ratings.click_vote(my_callback, {'value':value, 'advice_id': advice_id, 'profile_id': profile_id, 'isPerformance': isPerformance, 'is_submission': true, 'user_id': user_id});
          console.log("Voting for submission vote");
      });
    }

    $(function ()  
      { $("[rel=status]").popover({title: 'Status', content: "Status tells us how well the person is respected."});  
    });
    $(function ()  
      { $("[rel=reputation]").popover({title: 'Reputation', content: "Reputation tells us how well the person is respected."});  
    });  
  </script>
{% endblock %}

{% block body %}
<div class="container">

  <div class="advice_list large-12 columns">
    {% block content %}
      {% if advice_list %}
          {% for advice in advice_list %}

            <div class="large-8 columns">
              <h2>{{ advice.company }} <small>US: {{advice.ticker }}</small></h2>
              <div class="medium-8 columns">
                <div class="rating_left">
                  <h4 class="left"><small> Price Target: ${{advice.price_target}}</small></h4>
                </div>
                <div class="rating_right">
                  <h4 class="left"><small> Time Frame: ${{advice.time_frame}}</small></h4>
                </div>
              </div>
              {% if not is_control%}
                <div class="medium-8 columns">
                  <div class="rating_left"> 
                    <h4 class="left" rel="status" data-trigger="hover" data-placement="bottom"><small>Status: </small></h4>
                    <div class="rateit left custom_rating" data-rateit-value={{advice_status|get_item:advice}}  data-rateit-max="3" data-rateit-readonly="true"></div>
                  </div>

                  <div class="rating_right">
                    <h4 class="left " rel="reputation" data-trigger="hover" data-placement="bottom"><small>Reputation: </small></h4>
                    <div class="rateit left custom_rating" data-rateit-value={{advice_rep|get_item:advice}} data-rateit-max=3 data-rateit-readonly="true"></div>
                  </div>
                </div>
              {% endif %}
              <div class="medium-8 columns">
                <p class="advice_content">{{advice.content}}</p>
              </div>
              <div class="company_stats medium-3 columns"><h5>Statistics: <h5>
                <ul class="statistics">
                  <li>Common Equity</li>
                  <li>Stat 2</li>
                  <li>Stat 3</li>
                </ul>
              </div>
              
              <div class="large-8 columns">
                <div class="rating_left">
                  <h4 class="left"><small>Rate Quality: </small></h4>
                  {% if advice.company in quality_votes %}
                  <input type="range" value={{quality_votes|get_item:advice.company}} max="5" step="1" id="quality-backing{{forloop.counter}}">
                  <div class="rateit left custom_rating quality vote" data-rateit-backingfld="#quality-backing{{forloop.counter}}" 
                  data-rateit-value={{quality_votes|get_item:advice.company}}
                  data-advice-id={{advice.id}} data-profile-id={{profile_dict|get_item:advice}} data-rateit-resetable="false"></div>
                  {% else %}
                  <input type="range" max="5" step="1" id="quality-backing{{forloop.counter}}">
                  <div class="rateit left custom_rating quality vote" data-rateit-backingfld="#quality-backing{{forloop.counter}}" 
                  data-rateit-resetable="false"  data-rateit-ispreset="true" data-rateit-min="0" data-rateit-max="10" data-advice-id={{advice.id}} data-profile-id={{profile_dict|get_item:advice}}></div>
                  {% endif %}
                </div>

                <div class="rating_right">
                  <h4 class="left"><small>Rate Performance: </small></h4>
                  {% if advice.company in performance_votes %}
                  <input type="range" value={{performance_votes|get_item:advice.company}} max="5" step="1" id="performance-backing{{forloop.counter}}">
                  <div class="rateit left custom_rating performance vote" data-rateit-backingfld="#performance-backing{{forloop.counter}}" 
                   data-rateit-value={{performance_votes|get_item:advice.company}} data-advice-id={{advice.id}} data-profile-id={{profile_dict|get_item:advice}} data-rateit-resetable="false"></div>
                  {% else %}
                  <input type="range" max="5" step="1" id="performance-backing{{forloop.counter}}">
                  <div class="rateit left custom_rating performance vote" data-rateit-backingfld="#performance-backing{{forloop.counter}}" 
                  data-rateit-resetable="false"  data-rateit-ispreset="true" data-rateit-min="0" data-rateit-max="10" data-advice-id={{advice.id}} data-profile-id={{profile_dict|get_item:advice}}></div>
                  {% endif %}
                </div>
              </div>
              <hr>
            </div>
          {% endfor %}
          
          <script type="text/javascript">
            $(".rateit").bind('rated reset', function (event) {
              var rater = $(this);
              var value = rater.rateit('value');
              // $(this).attr('class', 'clicked');

              //Disable Voting
              // rater.rateit('readonly', true);

              var advice_id = $(rater).data('advice-id');
              var profile_id = $(rater).data('profile-id');
              var user_id = $($("#uid")[0]).data('uid');
              var isPerformance = rater.hasClass("performance");
              Dajaxice.ratings.click_vote(my_callback, {'value':value, 'advice_id': advice_id, 'profile_id': profile_id, 'isPerformance': isPerformance, 'is_submission': false, 'user_id': user_id});
            });
          </script>

      {% else %}
        <p>No advice is available.</p>
      {% endif %}
      <div class="large-12 columns">
        <center><button id="#submit" class="submit_button btn btn-default" data-toggle="modal" data-target="#submitModal" onclick="submit();">Submit</button></center>
      </div>
  </div>
    {% endblock %}
</div><!-- /.container -->


<!-- Modal -->
<div class="modal fade" id="submitModal" tabindex="-1" role="dialog" aria-labelledby="submitModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Survey</h4>
      </div>
        <div class="modal-body">
          This will be populated with the survey when I know what it entails.
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Save changes</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="loadModal" tabindex="-1" role="dialog" aria-labelledby="loadModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Welcome!</h4>
      </div>
        <div class="modal-body">
          Here is some info. Please vote!
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Ok</button>
      </div>
    </div>
  </div>
</div>
<div id="uid" data-uid={{user.user_id}}></div>
<div id="world" data-world={{world_number}}></div>
{% endblock %}